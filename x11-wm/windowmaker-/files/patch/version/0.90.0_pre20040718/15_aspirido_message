Hey all,

I think I fixed the Motif/Java focus problems that were reported. Attached is a patch against
CVS that:

1) (I hope) brings focus management to a sane state.
2) Fixes two crash bugs that I mailed about earlier.
3) Cleans up some old hacks that I believe to no longer be necessary.
4) Enables DEBUG in stacking.c, because CVS still has some latent stacking bugs that I
haven't been able to track down.

I'm asking whoever is willing to test it for a week or two, and write back if you find any problems.
If it's all good, I'd appreciate hearing from you as well.

More detailed discussion of the points above:

1) The focus changes are cumulative.
- Undo the WRONG patch applied back in July-August '03.
- Eat up extraneous events when switching workspaces. This saves us unnecessary
focusing and refocusing, and eliminates some titlebar flicker I noticed. (GTK2 titlebar
flicker was caused by WM_TAKE_FOCUS mishandling, too)
- Change all XSetInputFocus calls to use CurrentTime. This was done after carefully tracing
program/X behavior with xmon, and looking at about 5 other window managers, which all
have correct focusing behavior (and use CurrentTime for XSetInputFocus). A word of
warning: WM_TAKE_FOCUS *must* be sent with an actual time, and not CurrentTime.
Hence, the changes to the lastTimestamp stuff.

2) See these messages:
http://article.gmane.org/gmane.compw.window-managers.windowmaker.devel/466
http://article.gmane.org/gmane.compw.window-managers.windowmaker.devel/461

3) Since I always pass CurrentTime, in XSetInputFocus, the ignoreTimestamp hack
in processEvents (now wProcessEvents) should no longer be necessary. People who
use animations regularly, please confirm!

4) I guess this is mostly for Alfredo. I'd seen (very intermittently) two stacking bugs:
- From time to time, I hit the bug labeled "Internal inconsistency". I can't find a case to
reproduce it. However, with DEBUG enabled, we at least shouldn't crash when that
case is hit.
- Two or three times in a year, I found wmaker stuck in an infinite loop in AddToStackList,
around line 418 (the while loop).
I have any ideas on how to fix these without being able to reproduce them effectively.

Cheers,

Alexey 
