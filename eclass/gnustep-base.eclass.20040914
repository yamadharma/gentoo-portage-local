
ECLASS=gnustep-base
INHERITED="$INHERITED $ECLASS"

inherit patch extrafiles doc-tex

DESCRIPTION="Based on the gnustep eclass."

IUSE="doc"

DEPEND="${DEPEND}"

if [ -z "${GNUSTEP_ROOT}" ]
    then
    GNUSTEP_ROOT=/opt/GNUstep
fi

# LOGNAME broken in gnustep-make post 1.9.0
LOGNAME=portage

# {{{ This is hack (due broken LOGNAME)

#if [ -z "$GNUSTEP_FLATTENED" ]; then
#  addwrite `$GNUSTEP_MAKEFILES/$GNUSTEP_HOST_CPU/$GNUSTEP_HOST_OS/user_home user`/Defaults/.GNUstepDefaults.lck
#  addpredict `$GNUSTEP_MAKEFILES/$GNUSTEP_HOST_CPU/$GNUSTEP_HOST_OS/user_home user`
#else
#  addwrite `$GNUSTEP_MAKEFILES/user_home user`/Defaults/.GNUstepDefaults.lck
#  addpredict `$GNUSTEP_MAKEFILES/user_home user`
#fi
addwrite /root/GNUstep/Defaults/.GNUstepDefaults.lck
addpredict /root/GNUstep	

# }}}

configure_make ()
{	
if [ -f ${GNUSTEP_ROOT}/System/Library/Makefiles/GNUstep.sh ] 
    then
#    echo "" | sudo -u portage -S sh -c "source ${GNUSTEP_ROOT}/System/Library/Makefiles/GNUstep.sh"
    source ${GNUSTEP_ROOT}/System/Library/Makefiles/GNUstep.sh
else
    die "gnustep-make not installed!"
fi
}



HOME=${T}
GNUSTEP_USER_ROOT=${T}/GNUstep

gnustep-base_pkg_setup ()
{
    doc-tex_pkg_setup
    mkdir -p ${T}/GNUstep
}

gnustep-base_src_unpack ()
{
    patch_src_unpack

    cd ${S}
}


gnustep-base_src_compile () 
{
    configure_make
#    mkdir -p ${T}/GNUstep
    
    cd ${S}
    
#    unset CFLAGS
#    unset CC

    ./configure \
	HOME=${T} \
	GNUSTEP_USER_ROOT=${T}/GNUstep \
	INSTALL_AS_USER=portage \
	${myconf} \
	|| die "configure failed"
    
    make \
	HOME=${T} \
	GNUSTEP_USER_ROOT=${T}/GNUstep \
	|| die
	
    if ( use doc )
	then
	cd ${S}/Documentation
	make \
	    HOME=${T} \
	    GNUSTEP_USER_ROOT=${T}/GNUstep \
	    || die
    fi
}

gnustep-base_src_install () 
{
    configure_make
    
    cd ${S}
    
    make \
	GNUSTEP_USER_ROOT=${T}/GNUstep \
	HOME=${T} \
	GNUSTEP_INSTALLATION_DIR=${D}${GNUSTEP_SYSTEM_ROOT} \
	INSTALL_ROOT_DIR=${D} \
	install || die
    
    if ( use doc )
	then
	cd ${S}/Documentation
	make \
	    GNUSTEP_INSTALLATION_DIR=${D}${GNUSTEP_SYSTEM_ROOT} \
	    INSTALL_ROOT_DIR=${D} \
	    install || die
    fi
}

EXPORT_FUNCTIONS pkg_setup src_unpack src_compile src_install

# Local Variables:
# mode: sh
# End:
