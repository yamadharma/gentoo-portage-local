
ECLASS="gnustep-app"

inherit patch extrafiles doc-tex
INHERITED="$INHERITED $ECLASS"

DESCRIPTION="Based on the gnustep eclass."

IUSE="doc"

newdepend	"gnustep-base/gnustep-make"
newdepend	"gnustep-base/gnustep-base"

# LOGNAME broken in gnustep-make post 1.9.0
LOGNAME=portage

# {{{ This is hack (due broken LOGNAME)

#if [ -z "$GNUSTEP_FLATTENED" ]; then
#  addwrite `$GNUSTEP_MAKEFILES/$GNUSTEP_HOST_CPU/$GNUSTEP_HOST_OS/user_home user`/Defaults/.GNUstepDefaults.lck
#  addpredict `$GNUSTEP_MAKEFILES/$GNUSTEP_HOST_CPU/$GNUSTEP_HOST_OS/user_home user`
#else
#  addwrite `$GNUSTEP_MAKEFILES/user_home user`/Defaults/.GNUstepDefaults.lck
#  addpredict `$GNUSTEP_MAKEFILES/user_home user`
#fi
addwrite /root/GNUstep/Defaults/.GNUstepDefaults.lck
addpredict /root/GNUstep	

# }}}

configure_make ()
{
if [ -f ${GNUSTEP_ROOT}/System/Library/Makefiles/GNUstep.sh ] 
    then
    source ${GNUSTEP_ROOT}/System/Library/Makefiles/GNUstep.sh
else
    die "gnustep-make not installed!"
fi

GNUSTEP_INSTALLATION_DIR=${D}${GNUSTEP_SYSTEM_ROOT}
INSTALL_ROOT_DIR=${D}
}

EXPORT_FUNCTIONS src_unpack src_compile src_install

gnustep-app_src_unpack ()
{
    configure_make
    
    patch_src_unpack

    cd ${S}
}


gnustep-app_src_compile () 
{
    configure_make
    
    if [ -x configure ]  
 	then
	./configure \
	    ${myconf} \
	    || die "configure failed"
    fi    


    make \
	HOME=${T} \
	GNUSTEP_USER_ROOT=${T}/GNUstep \
	GNUSTEP_INSTALLATION_DIR=${GNUSTEP_SYSTEM_ROOT} \
	|| die



    if [ ! -z "${S_ADD}" ]
	then
	for i in ${S_ADD}
	  do
	  cd ${S}
	  cd ${i}
	  make \
	      HOME=${T} \
	      GNUSTEP_USER_ROOT=${T}/GNUstep \
	      || die
	done
    fi
    

    if ( use doc )
	then
	if [ ! -z "${extradocdir}" ]
	    then
	    for i in "${extradocdir}"
	    do
		cd ${S}
		cd ${i}
		make \
		    HOME=${T} \
		    GNUSTEP_USER_ROOT=${T}/GNUstep \
		    || die
	    done
	fi
    fi
}

gnustep-app_src_install () 
{
    configure_make
    
    cd ${S}

    make \
	GNUSTEP_USER_ROOT=${T}/GNUstep \
	HOME=${T} \
	GNUSTEP_INSTALLATION_DIR=${D}${GNUSTEP_SYSTEM_ROOT} \
	INSTALL_ROOT_DIR=${D} \
	install || die
    
    if [ ! -z "${S_ADD}" ]
	then
	for i in ${S_ADD}
	  do
	  cd ${S}
	  cd ${i}
	  make \
	      GNUSTEP_USER_ROOT=${T}/GNUstep \
	      HOME=${T} \
	      GNUSTEP_INSTALLATION_DIR=${D}${GNUSTEP_ROOT}/System \
	      GNUSTEP_LOCAL_ROOT=${D}${GNUSTEP_ROOT}/Local \
	      GNUSTEP_NETWORK_ROOT=${D}${GNUSTEP_ROOT}/Network \
	      GNUSTEP_SYSTEM_ROOT=${D}${GNUSTEP_ROOT}/System \
	      INSTALL_ROOT_DIR=${D} \
	      install || die
	done
    fi
    
    if [ ! -z "${mydoc}" ]
	then
	cd ${S}
	dodoc ${mydoc}
    fi

    if ( use doc )
	then
	if [ ! -z "${extradocdir}" ]
	    then
	    for i in "${extradocdir}"
	    do
		cd ${S}
		cd ${i}
		make \
	    	    GNUSTEP_USER_ROOT=${T}/GNUstep \
	    	    HOME=${T} \
	    	    GNUSTEP_INSTALLATION_DIR=${D}${GNUSTEP_ROOT}/System \
	    	    GNUSTEP_LOCAL_ROOT=${D}${GNUSTEP_ROOT}/Local \
	    	    GNUSTEP_NETWORK_ROOT=${D}${GNUSTEP_ROOT}/Network \
	    	    GNUSTEP_SYSTEM_ROOT=${D}${GNUSTEP_ROOT}/System \
	    	    INSTALL_ROOT_DIR=${D} \
	    	    install || die
	    done
	fi
    fi

    extrafiles_install
}

# Local Variables:
# mode: sh
# End:
