#!/bin/sh
cmd=0
if [ -z "$1" ]; then
  cmd=1
else
  if [ "$1" = "e16" ]; then
    cmd=0
  elif [ "$1" = "fluxbox" ]; then
    cmd=0
  elif [ "$1" = "gnome" ]; then
    cmd=0
  else
    cmd=1
  fi
fi

processes=$(ps auxf)
xgl_running=$(echo $processes | grep Xgl)
acceleration_enabled=$(glxinfo | grep "direct rendering" | grep -i "yes")
aquamarine_exists=$(cat /proc/cmdline | grep aquamarine)

# Choose the WM
if [ -e /usr/bin/aquamarine ] && [ -n "$aquamarine_exists" ];then
  if [ "$1" = "gnome" ]; then
    window_decor="emerald --replace"
  elif [ "$1" = "xfce" ]; then
    window_decor="emerald --replace"
  else
    window_decor="aquamarine --replace"
  fi
else
  window_decor="emerald --replace"
fi

# Start Beryl
if [ -n "$acceleration_enabled" ] || [ -n "$xgl_running" ]; then
  if [ "$cmd" = "1" ]; then
    if [ -n "$xgl_running" ]; then
      $window_decor & beryl-xgl --xgl-rendering --replace 
      # workaround for SHIFT+BACKSPACE bug in XGL
      xmodmap -e "keycode 22 = BackSpace BackSpace Terminate_Server"
      xmodmap -e "keycode 113 = Mode_switch"
      xmodmap -e "add mode4 = Super_L"
      xmodmap -e "add mode4 = Super_R"
    else
      $window_decor & beryl --strict-binding --indirect-rendering --replace
    fi
  fi
else
   # Notify the funny thing
   dcop knotify default notify DRI_status 'Direct Rendering' 'OpenGL acceleration is disabled. 3D Desktop cannot be loaded.' '' '' 2 0
fi
