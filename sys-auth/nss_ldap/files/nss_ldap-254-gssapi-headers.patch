http://bugs.gentoo.org/show_bug.cgi?id=165638
http://bugzilla.padl.com/show_bug.cgi?id=308

Make nss_ldap compile with gssapi/gssapi.h even if there is no
gssapi/gssapi_krb5.h present. This seems to be needed to compile against
heimdal. Extended header checks and modified preprocessor logic a bit.

2007-02-07 Martin von Gagern <Martin.vGagern@gmx.net>

diff -u nss_ldap-254.orig/config.h.in nss_ldap-254/config.h.in
--- nss_ldap-254.orig/config.h.in	2007-02-07 11:03:26.000000000 +0100
+++ nss_ldap-254/config.h.in	2007-02-07 11:04:06.000000000 +0100
@@ -84,6 +84,9 @@
 /* Define to 1 if you have the <gssapi/gssapi_krb5.h> header file. */
 #undef HAVE_GSSAPI_GSSAPI_KRB5_H
 
+/* Define to 1 if you have the <gssapi/gssapi.h> header file. */
+#undef HAVE_GSSAPI_GSSAPI_H
+
 /* Define to 1 if you have the <gssapi.h> header file. */
 #undef HAVE_GSSAPI_H
 
diff -u nss_ldap-254.orig/configure nss_ldap-254/configure
--- nss_ldap-254.orig/configure	2007-02-07 11:03:26.000000000 +0100
+++ nss_ldap-254/configure	2007-02-07 11:04:24.000000000 +0100
@@ -2730,7 +2730,7 @@
 fi
 done
 
-for ac_hdr in gssapi/gssapi_krb5.h gssapi.h
+for ac_hdr in gssapi/gssapi_krb5.h gssapi/gssapi.h gssapi.h
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
diff -u nss_ldap-254.orig/configure.in nss_ldap-254/configure.in
--- nss_ldap-254.orig/configure.in	2007-02-07 11:03:26.000000000 +0100
+++ nss_ldap-254/configure.in	2007-02-07 11:04:41.000000000 +0100
@@ -180,7 +180,7 @@
 AC_CHECK_HEADERS(strings.h)
 AC_CHECK_HEADERS(gssldap.h)
 AC_CHECK_HEADERS(gsssasl.h)
-AC_CHECK_HEADERS(gssapi/gssapi_krb5.h gssapi.h)
+AC_CHECK_HEADERS(gssapi/gssapi_krb5.h gssapi/gssapi.h gssapi.h)
 
 AC_CHECK_LIB(resolv, main)
 AC_CHECK_LIB(nsl, main)
diff -u nss_ldap-254.orig/ldap-nss.c nss_ldap-254/ldap-nss.c
--- nss_ldap-254.orig/ldap-nss.c	2007-02-07 11:03:26.000000000 +0100
+++ nss_ldap-254/ldap-nss.c	2007-02-07 11:05:31.000000000 +0100
@@ -82,10 +82,14 @@
 #endif
 #ifdef HAVE_GSSAPI_H
 #include <gssapi.h>
-#elif defined(HAVE_GSSAPI_GSSAPI_KRB5_H)
+#else
+#ifdef HAVE_GSSAPI_GSSAPI_H
 #include <gssapi/gssapi.h>
+#endif
+#ifdef HAVE_GSSAPI_GSSAPI_KRB5_H
 #include <gssapi/gssapi_krb5.h>
+#endif
 #endif
 
 #include "ldap-nss.h"
 #include "ltf.h"
